---
description: "功能开发的实施计划模板"
scripts:
  sh: scripts/bash/update-agent-context.sh __AGENT__
  ps: scripts/powershell/update-agent-context.ps1 -AgentType __AGENT__
---

# 实施计划：[FEATURE]

**分支**: `[###-feature-name]` | **日期**: [DATE] | **规格**: [link]
**输入**: 来自 `/specs/[###-feature-name]/spec.md` 的功能规格

## 执行流程（/plan 命令范围）
```
1. 从输入路径加载功能规格
   → 如果未找到：错误 "在 {path} 处未找到功能规格"
2. 填充技术上下文（扫描需要澄清的内容）
   → 从上下文检测项目类型（web=前端+后端，mobile=应用+api）
   → 根据项目类型设置结构决策
3. 评估下面的宪法检查部分
   → 如果存在违规：在复杂性跟踪中记录
   → 如果无法证明合理性：错误 "请先简化方法"
   → 更新进度跟踪：初始宪法检查
4. 执行阶段 0 → research.md
   → 如果仍有需要澄清的内容：错误 "请解决未知问题"
5. 执行阶段 1 → contracts, data-model.md, quickstart.md, agent-specific 模板文件（例如，Claude Code 的 `CLAUDE.md`，GitHub Copilot 的 `.github/copilot-instructions.md`，或 Gemini CLI 的 `GEMINI.md`）
6. 重新评估宪法检查部分
   → 如果有新的违规：重构设计，返回阶段 1
   → 更新进度跟踪：设计后宪法检查
7. 计划阶段 2 → 描述任务生成方法（不要创建 tasks.md）
8. 停止 - 准备执行 /tasks 命令
```

**重要说明**: /plan 命令在第 7 步停止。阶段 2-4 由其他命令执行：
- 阶段 2: /tasks 命令创建 tasks.md
- 阶段 3-4: 实施执行（手动或通过工具）

## 摘要
[从功能规格中提取：主要需求 + 来自研究的技术方法]

## 技术上下文
**语言/版本**: [例如，Python 3.11, Swift 5.9, Rust 1.75 或需要澄清]
**主要依赖**: [例如，FastAPI, UIKit, LLVM 或需要澄清]
**存储**: [如果适用，例如，PostgreSQL, CoreData, files 或不适用]
**测试**: [例如，pytest, XCTest, cargo test 或需要澄清]
**目标平台**: [例如，Linux 服务器，iOS 15+, WASM 或需要澄清]
**项目类型**: [单个/web/移动 - 决定源代码结构]
**性能目标**: [特定领域，例如 1000 请求/秒，10k 行/秒，60 fps 或需要澄清]
**约束**: [特定领域，例如 <200ms p95，<100MB 内存，离线能力 或需要澄清]
**规模/范围**: [特定领域，例如 10k 用户，1M LOC，50 个屏幕 或需要澄清]

## 宪法检查
*门控：必须在阶段 0 研究之前通过。在阶段 1 设计后重新检查。*

**简洁性**：
- 项目：[#]（最多 3 个 - 例如，api, cli, tests）
- 直接使用框架？（没有包装类）
- 单一数据模型？（除非序列化不同，否则没有 DTO）
- 避免的模式？（没有经过验证需要的 Repository/UoW）

**架构**：
- 每个功能都作为库？（没有直接的应用代码）
- 列出的库：[每个库的名称 + 用途]
- 每个库的 CLI：[带有 --help/--version/--format 的命令]
- 库文档：计划使用 llms.txt 格式？

**测试（不可协商）**：
- 强制执行 RED-GREEN-Refactor 循环？（测试必须先失败）
- Git 提交显示测试在实现之前？
- 严格遵循顺序：Contract→Integration→E2E→Unit？
- 使用真实依赖？（实际数据库，不是模拟）
- 集成测试用于：新库、合约变更、共享模式？
- 禁止：在测试之前实现，跳过 RED 阶段

**可观察性**：
- 包含结构化日志？
- 前端日志 → 后端？（统一流）
- 错误上下文充分？

**版本控制**：
- 分配了版本号？（MAJOR.MINOR.BUILD）
- 每次变更都增加 BUILD？
- 处理破坏性变更？（并行测试，迁移计划）

## 项目结构

### 文档（此功能）
```
specs/[###-feature]/
├── plan.md              # 此文件（/plan 命令输出）
├── research.md          # 阶段 0 输出（/plan 命令）
├── data-model.md        # 阶段 1 输出（/plan 命令）
├── quickstart.md        # 阶段 1 输出（/plan 命令）
├── contracts/           # 阶段 1 输出（/plan 命令）
└── tasks.md             # 阶段 2 输出（/tasks 命令 - 不由 /plan 创建）
```

### 源代码（仓库根目录）
```
# 选项 1：单个项目（默认）
src/
├── models/
├── services/
├── cli/
└── lib/

tests/
├── contract/
├── integration/
└── unit/

# 选项 2：Web 应用程序（当检测到 "frontend" + "backend" 时）
backend/
├── src/
│   ├── models/
│   ├── services/
│   └── api/
└── tests/

frontend/
├── src/
│   ├── components/
│   ├── pages/
│   └── services/
└── tests/

# 选项 3：移动应用 + API（当检测到 "iOS/Android" 时）
api/
└── [与上面的 backend 相同]

ios/ 或 android/
└── [平台特定结构]
```

**结构决策**: [默认选择选项 1，除非技术上下文表明是 web/移动应用]

## 阶段 0：大纲与研究
1. **从上面的技术上下文中提取未知内容**：
   - 对于每个需要澄清的内容 → 研究任务
   - 对于每个依赖 → 最佳实践任务
   - 对于每个集成 → 模式任务

2. **生成并派遣研究代理**：
   ```
   对于技术上下文中的每个未知内容：
     任务："为 {feature context} 研究 {unknown}"
   对于每个技术选择：
     任务："在 {domain} 中找到 {tech} 的最佳实践"
   ```

3. **在 `research.md` 中整合发现**，使用格式：
   - 决策：[选择了什么]
   - 理由：[为什么选择]
   - 考虑的替代方案：[还评估了什么]

**输出**: research.md，所有需要澄清的内容都已解决

## 阶段 1：设计与合约
*前提条件：research.md 完成*

1. **从功能规格中提取实体** → `data-model.md`：
   - 实体名称、字段、关系
   - 来自需求的验证规则
   - 状态转换（如果适用）

2. **从功能需求生成 API 合约**：
   - 对于每个用户操作 → 端点
   - 使用标准 REST/GraphQL 模式
   - 输出 OpenAPI/GraphQL 模式到 `/contracts/`

3. **从合约生成合约测试**：
   - 每个端点一个测试文件
   - 断言请求/响应模式
   - 测试必须失败（尚未实现）

4. **从用户故事中提取测试场景**：
   - 每个故事 → 集成测试场景
   - 快速启动测试 = 故事验证步骤

5. **逐步更新代理文件**（O(1) 操作）：
   - 为您的 AI 助手运行 `/scripts/update-agent-context.sh [claude|gemini|copilot]`
   - 如果存在：仅添加当前计划中的新技术
   - 保留标记之间的手动添加内容
   - 更新最近的更改（保留最后 3 个）
   - 保持低于 150 行以提高 token 效率
   - 输出到仓库根目录

**输出**: data-model.md, /contracts/*, 失败的测试, quickstart.md, agent-specific 文件

## 阶段 2：任务规划方法
*本节描述 /tasks 命令将做什么 - 不要在 /plan 期间执行*

**任务生成策略**：
- 加载 `/templates/tasks-template.md` 作为基础
- 从阶段 1 设计文档生成任务（合约、数据模型、快速启动）
- 每个合约 → 合约测试任务 [P]
- 每个实体 → 模型创建任务 [P]
- 每个用户故事 → 集成测试任务
- 使测试通过的实施任务

**排序策略**：
- TDD 顺序：测试在实现之前
- 依赖顺序：模型在服务之前，服务在 UI 之前
- 标记 [P] 用于并行执行（独立文件）

**预计输出**: tasks.md 中 25-30 个编号的、有序的任务

**重要说明**: 此阶段由 /tasks 命令执行，而不是由 /plan 执行

## 阶段 3+：未来实施
*这些阶段超出了 /plan 命令的范围*

**阶段 3**: 任务执行（/tasks 命令创建 tasks.md）
**阶段 4**: 实施（按照宪法原则执行 tasks.md）
**阶段 5**: 验证（运行测试，执行 quickstart.md，性能验证）

## 复杂性跟踪
*仅在宪法检查有必须证明合理性的违规时填写*

| 违规 | 需要原因 | 拒绝的更简单替代方案 |
|------|----------|-------------------|
| [例如，第 4 个项目] | [当前需求] | [为什么 3 个项目不够] |
| [例如，Repository 模式] | [特定问题] | [为什么直接数据库访问不够] |


## 进度跟踪
*此检查清单在执行流程期间更新*

**阶段状态**：
- [ ] 阶段 0：研究完成（/plan 命令）
- [ ] 阶段 1：设计完成（/plan 命令）
- [ ] 阶段 2：任务规划完成（/plan 命令 - 仅描述方法）
- [ ] 阶段 3：任务生成（/tasks 命令）
- [ ] 阶段 4：实施完成
- [ ] 阶段 5：验证通过

**门控状态**：
- [ ] 初始宪法检查：通过
- [ ] 设计后宪法检查：通过
- [ ] 所有需要澄清的内容已解决
- [ ] 复杂性偏差已记录

---
*基于宪法 v2.1.1 - 参见 `/memory/constitution.md`*