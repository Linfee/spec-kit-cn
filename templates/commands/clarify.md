---
description: 通过询问最多5个高度针对性的澄清问题来识别当前功能规范中的未指定领域，并将答案编码回规范。
scripts:
  sh: scripts/bash/check-prerequisites.sh --json --paths-only
  ps: scripts/powershell/check-prerequisites.ps1 -Json -PathsOnly
---

用户输入可以直接由代理提供或作为命令参数提供给您 - 您**必须**考虑它（如果不为空）。

用户输入：

$ARGUMENTS

目标：检测并减少活动功能规范中的模糊性或缺失决策点，并将澄清直接记录在规范文件中。

注意：此澄清工作流应在调用 `/plan` **之前**运行（并完成）。如果用户明确表示跳过澄清（例如，探索性原型开发），可以继续，但必须警告下游返工风险增加。

执行步骤：

1. 从仓库根目录运行一次 `{SCRIPT}` **（组合 `--json --paths-only` 模式 / `-Json -PathsOnly`）。解析最小JSON负载字段：
   - `FEATURE_DIR`
   - `FEATURE_SPEC`
   - （可选捕获 `IMPL_PLAN`、`TASKS` 以用于未来链式流）。
   - 如果JSON解析失败，中止并指示用户重新运行 `/specify` 或验证功能分支环境。

2. 加载当前规范文件。使用此分类框架执行结构化模糊性和覆盖扫描。对于每个类别，标记状态：清晰 / 部分 / 缺失。生成用于优先化的内部覆盖映射（除非将不询问问题，否则不输出原始映射）。

   功能范围和行为：
   - 核心用户目标和成功标准
   - 显式的范围外声明
   - 用户角色/角色区分

   领域和数据模型：
   - 实体、属性、关系
   - 身份和唯一性规则
   - 生命周期/状态转换
   - 数据量/规模假设

   交互和UX流程：
   - 关键用户旅程/序列
   - 错误/空/加载状态
   - 可访问性或本地化说明

   非功能质量属性：
   - 性能（延迟、吞吐量目标）
   - 可扩展性（水平/垂直，限制）
   - 可靠性和可用性（正常运行时间、恢复期望）
   - 可观察性（日志记录、指标、跟踪信号）
   - 安全性和隐私（身份验证/授权、数据保护、威胁假设）
   - 合规性/监管约束（如果有）

   集成和外部依赖：
   - 外部服务/API及其故障模式
   - 数据导入/导出格式
   - 协议/版本控制假设

   边界情况和故障处理：
   - 负面场景
   - 速率限制/节流
   - 冲突解决（例如，并发编辑）

   约束和权衡：
   - 技术约束（语言、存储、托管）
   - 显式权衡或拒绝的替代方案

   术语和一致性：
   - 规范术语表术语
   - 避免的同义词/已弃用术语

   完成信号：
   - 验收标准的可测试性
   - 可衡量的"完成"风格定义指示器

   杂项/占位符：
   - TODO 标记/未解决的决策
   - 缺少量化的模糊形容词（"健壮"、"直观"）

   对于每个状态为部分或缺失的类别，添加候选问题机会，除非：
   - 澄清不会实质性地改变实施或验证策略
   - 信息更适合推迟到规划阶段（内部记录）

3. 生成（内部）候选澄清问题的优先级队列（最多5个）。不要一次性输出它们。应用这些约束：
   - 整个会话最多5个问题。
   - 每个问题必须可以用以下任一方式回答：
       * 简短的多项选择题（2–5个不同且互斥的选项），或
       * 单词/短短语答案（显式约束："答案<=5个词"）。
   - 只包含其答案实质上影响架构、数据建模、任务分解、测试设计、UX行为、运营准备度或合规性验证的问题。
   - 确保类别覆盖平衡：尝试首先覆盖最高影响的未解决类别；当单个高影响领域（例如，安全姿态）未解决时，避免询问两个低影响问题。
   - 排除已回答的问题、琐碎的风格偏好，或计划级执行细节（除非阻碍正确性）。
   - 偏好减少下游返工风险或防止错误验收测试的澄清。
   - 如果余下超过5个类别未解决，按（影响度 × 不确定性）评估标准选择前5个。

4. 顺序提问循环（交互式）：
   - 一次只呈现**一个**问题。
   - 对于多项选择题，将选项呈现为Markdown表：

       | 选项 | 描述 |
       |--------|-------------|
       | A | <选项A描述> |
       | B | <选项B描述> |
       | C | <选项C描述> | （根据需要添加D/E，最多5个）
       | 简答 | 提供不同的短答案（<=5个词） | （仅在自由形式替代合适时包含）

   - 对于短答案风格（无有意义离散选项），在问题后输出单行：`格式：短答案（<=5个词）`。
   - 用户回答后：
       * 验证答案映射到一个选项或符合<=5个词约束。
       * 如果模糊，要求快速消歧义（计数仍属于同一问题；不要前进）。
       * 一旦满意，将其记录在工存记忆中（尚未写入磁盘）并移动到下一个排队问题。
   - 在以下情况停止进一步提问：
       * 所有关键模糊性早期解决（余下排队项变得不必要），或
       * 用户发出完成信号（"完成"、"好"、"没有更多"），或
       * 您达到5个已问问题。
   - 永远不要提前揭示未来排队的问题。
   - 如果开始时没有有效问题存在，立即报告没有关键模糊性。

5. 每个接受答案后的集成（增量更新方法）：
   - 维护规范的内存表示（在开始时加载一次）加上原始文件内容。
   - 对于此会话中第一个集成的答案：
       * 确保 `## 澄清` 部分存在（如果缺失，就在规范模板的最高级上下文/概述部分之后创建它）。
       * 在其下，为今天创建（如果不存在）`### 会话 YYYY-MM-DD` 子标题。
   - 在验收后立即添加项目符号行：`- Q: <问题> → A: <最终答案>`。
   - 然后立即将澄清应用于最合适的部分：
       * 功能模糊性 → 更新或在功能需求中添加项目符号。
       * 用户交互/角色区分 → 使用澄清的角色、约束或场景更新用户故事或角色小节（如果存在）。
       * 数据形状/实体 → 更新数据模型（添加字段、类型、关系）保持顺序；简洁地记录添加的约束。
       * 非功能约束 → 在非功能/质量属性部分添加/修改可衡量标准（将模糊形容词转换为指标或显式目标）。
       * 边界情况/负流程 → 在边界情况/错误处理下添加新项目符号（如果模板为其提供占位符则创建此类小节）。
       * 术语冲突 → 在整个规范中规范化术语；仅在必要时通过添加 `(先前称为"X")` 保留原始术语。
   - 如果澄清代替了较早的模糊陈述，替换该陈述而不是复制；不要留下过时的矛盾文本。
   - 每次集成后保存规范文件以最小化上下文丢失风险（原子覆盖）。
   - 保留格式：不要重新排序无关部分；保持标题层次结构完整。
   - 保持每个插入的澄清最小化和可测试（避免叙述漂移）。

6. 验证（每次写入后执行加上最终遍历）：
   - 澄清会话包含每个接受答案正好一个项目符号（无重复）。
   - 已问（接受）问题数 ≤ 5。
   - 更新的部分包含新答案旨在解决的剩余模糊占位符。
   - 没有余下的矛盾较早陈述（扫描移除的现在无效替代选择）。
   - Markdown结构有效；只允许新标题：`## 澄清`、`### 会话 YYYY-MM-DD`。
   - 术语一致性：在所有更新部分中使用相同的规范术语。

7. 将更新的规范写回 `FEATURE_SPEC`。

8. 报告完成（提问循环结束或提前终止后）：
   - 已问和已回答的问题数。
   - 更新规范的路径。
   - 触及的部分列表（名称）。
   - 覆盖摘要表列出每个分类法类别，状态为：已解决（曾经为部分/缺失并已处理）、推迟（超出问题配额或更适合规划）、清晰（已经足够）、突出（仍然部分/缺失但低影响）。
   - 如果任何突出或推迟余下，建议是否继续到 `/plan` 或在规划后再次运行 `/clarify`。
   - 建议的下一个命令。

行为规则：
- 如果没有发现有意义的模糊性（或所有潜在问题都是低影响），响应："未发现值得正式澄清的关键模糊性。"并建议继续。
- 如果规范文件缺失，指示用户首先运行 `/specify`（不要在此创建新规范）。
- 永远不要超过5个总已问问题（单个问题的澄清重试不计为新问题）。
- 避免推测性技术栈问题，除非缺失阻碍功能清晰度。
- 尊重用户提前终止信号（"停止"、"完成"、"继续"）。
- 如果由于完全覆盖而没有问问题，输出紧凑的覆盖摘要（所有类别清晰）然后建议前进。
- 如果达到配额时余下未解决的高影响类别，在推迟下明确标记它们及其基本原理。

优先化上下文：{ARGS}
